version: "3.8"

networks:
  ppe:

services:
  backend:
    build:
      context: ../../app
      dockerfile: backend/Dockerfile
    image: ppe-compliance-monitor-backend:local
    command: ["python", "/app/backend/app.py"]
    environment:
      CORS_ORIGINS: "http://localhost:3000,http://0.0.0.0:3000,http://127.0.0.1:3000"
    ports:
      - "8888:8888"
    networks:
      - ppe

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"  # MinIO Console port
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_SERVER_URL=http://minio:9000
    command: server /data --console-address ":9001"
    networks:
      - ppe
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - minio_data:/data

  frontend:
    build:
      context: ../../app/frontend
      dockerfile: Dockerfile
    image: ppe-compliance-monitor-frontend:local
    depends_on:
      - backend
    networks:
      - ppe
    environment:
      FRONTEND_API_URL: "http://localhost:8888/api"
    command:
      - sh
      - -c
      - >
        printf "window.__ENV__ = { API_URL: \"%s\" };\n" "$${FRONTEND_API_URL}" > /app/build/env.js
        && serve -s /app/build -l tcp://0.0.0.0:3000
    ports:
      - "3000:3000"

volumes:
  minio_data: