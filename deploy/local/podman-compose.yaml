version: "3.8"

networks:
  ppe:


services:
  # Init service: loads model and video files into shared volume
  data-loader:
    build:
      context: ../../app
      dockerfile: data-image/Dockerfile
    image: ppe-compliance-monitor-data:local
    command:
      - sh
      - -c
      - |
        mkdir -p /shared/data /shared/models
        cp -r /data/* /shared/data/
        cp -r /models/* /shared/models/
        echo "Data loaded successfully"
    volumes:
      - shared-data:/shared

  backend:
    build:
      context: ../../app
      dockerfile: backend/Dockerfile
    image: ppe-compliance-monitor-backend:local
    command: ["python", "/app/backend/app.py"]
    depends_on:
      data-loader:
        condition: service_completed_successfully
    environment:
      CORS_ORIGINS: "http://localhost:3000,http://0.0.0.0:3000,http://127.0.0.1:3000"
      MODEL_PATH: /app/shared/models/ppe.pt
      VIDEO_PATH: /app/shared/data/combined-video-no-gap-rooftop.mp4
    volumes:
      - shared-data:/app/shared
    ports:
      - "8888:8888"
    networks:
      - ppe

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001" # MinIO Console port
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_SERVER_URL=http://minio:9000
    command: server /data --console-address ":9001"
    networks:
      - ppe
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - minio_data:/data

  frontend:
    build:
      context: ../../app/frontend
      dockerfile: Dockerfile
    image: ppe-compliance-monitor-frontend:local
    depends_on:
      - backend
    networks:
      - ppe
    environment:
      FRONTEND_API_URL: "http://localhost:8888/api"
    command:
      - sh
      - -c
      - >
        printf "window.__ENV__ = { API_URL: \"%s\" };\n" "$${FRONTEND_API_URL}" > /app/build/env.js && serve -s /app/build -l tcp://0.0.0.0:3000 #magic___^_^___line
    ports:
      - "3000:3000"


volumes:
  shared-data:
  minio_data:
  model_repo:
